name: SSH smoke test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  ssh-smoke:
    name: Container-based SSH smoke test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Compose
        uses: docker/setup-buildx-action@v2

      - name: Start services (web + git-bridge)
        run: |
          docker compose -f develop/docker-compose.yml --project-directory develop up -d --build web git-bridge

      - name: Wait for Web launchpad
        run: |
          until curl -sSf http://127.0.0.1:13000/launchpad >/dev/null 2>&1; do sleep 2; done

      - name: Run SSH smoke wrapper script
        run: |
          bash scripts/ci/run_ssh_smoke_ci.sh

      - name: Upload e2e artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ssh-smoke-artifacts
          path: services/web/test/e2e/playwright/out/

      - name: Teardown
        if: always()
        run: |
          docker compose -f develop/docker-compose.yml --project-directory develop down --remove-orphans
