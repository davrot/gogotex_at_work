name: Perf: git-bridge

on:
  schedule:
    - cron: '0 2 * * *' # run daily at 02:00 UTC
  workflow_dispatch: {}

jobs:
  run-perf:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Git
        run: sudo apt-get update && sudo apt-get install -y git jq
      - name: Run perf benchmark
        run: bash services/git-bridge/test/perf/benchmark_clone_push.sh | tee perf.out
      - name: Check perf thresholds
        env:
          P95_THRESHOLD_MS: 2000
          P99_THRESHOLD_MS: 10000
        run: |
          bash services/git-bridge/test/perf/check_perf_thresholds.sh services/git-bridge/test/perf/report.json
      - name: Upload perf results
        uses: actions/upload-artifact@v4
        with:
          name: perf/git-bridge-$(date +'%Y%m%d')
          path: services/git-bridge/test/perf/report.json
